name: PB Automation Scheduled Run

on:
  schedule:
    # This cron runs every day at 11:58 UTC (which is 6:58 AM CDT / 6:58 AM CST)
    # We'll use sleep to adjust for the seconds
    - cron: "59 11 * * *"
  workflow_dispatch: {}  # optional manual trigger
  push:
    branches:
      - main

jobs:
  run-script:
    runs-on: ubuntu-latest

    # Set PLAYWRIGHT_BROWSERS_PATH globally for all steps
    env:
      PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v5

      # 2️⃣ Setup Python & UV
      - name: Setup Python
        uses: astral-sh/setup-uv@v7.0

      # 3️⃣ Sync dependencies
      - name: Sync dependencies
        run: uv sync

      # 4️⃣ Restore Playwright browser cache
      - name: Restore Playwright browser cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium
          restore-keys: playwright-chromium

      # 5️⃣ Install Chromium only if not cached
      - name: Install Playwright Chromium
        run: |
          if [ -z "$(ls -d ~/.cache/ms-playwright/chromium-* 2>/dev/null)" ]; then
            echo "Chromium not found — installing..."
            uv run playwright install chromium --with-deps
          else
            echo "Chromium found — skipping install."
          fi

      # 6️⃣ Run the script
      - name: Run script
        env:
          PB_USERNAME: msaifhassan@gmail.com
          PB_PASSWORD: ${{ secrets.PB_PASSWORD }}
          SENDER_EMAIL: msaifhassan@gmail.com
          RECEIVER_EMAIL: msaifhassan@gmail.com
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          TEST_MODE: false
        run: |
          uv run python src/pb_automation/auto.py